# We set the language to c because python isn't supported on the MacOS X nodes
# on Travis. However, the language ends up being irrelevant anyway, since we
# install Python ourselves using conda.
language: c

os:
    - linux

sudo: false

addons:
    apt:
        packages:
            - graphviz
            - texlive-latex-extra
            - dvipng

env:
    global:
        - SETUP_CMD='test'
        - TEST_CMD='py.test test_env.py'
        - PYTHON_VERSION=3.6
        - DEBUG=True

matrix:
    include:

        # -> tests sunpy dev
        # -> Starting with the dev versions as they take the longest to run. We
        #    deliberately test with Numpy 1.10 to check that installing Astropy
        #    dev doesn't upgrade Numpy.
        - os: linux
          env: SETUP_CMD='test' NUMPY_VERSION=1.10 ASTROPY_VERSION=dev
               PYTHON_VERSION=3.5 SUNPY_VERSION=dev CONDA_CHANNELS='conda-forge'

        # -> For the Numpy dev build, we also specify a conda package that
        #    depends on Numpy to make sure that Numpy dev is used (because
        #    conda will also install Numpy stable). It's also important to
        #    include scipy here to make sure that scipy routines still work
        #    correctly, because if we aren't careful, we can end up with issues
        #    with the math kernel library.
        - os: linux
          env: SETUP_CMD='test' NUMPY_VERSION=dev
               CONDA_DEPENDENCIES='scipy'

        # -> Note that setting CONDA_CHANNEL_PRIORITY to False here is unrelated
        #    to the rest of the build and won't change anything, except that we
        #    can make sure the conda config was correctly updated.
        - os: linux
          env: SETUP_CMD='test' NUMPY_VERSION=1.10 DEBUG=True
               SCIKIT_IMAGE_VERSION=0.11 PYTHON_VERSION=3.5
               CONDA_DEPENDENCIES='Cython numpy scikit-image'
               CONDA_CHANNEL_PRIORITY=False

        - os: linux
          env: CONDA_CHANNELS='conda-forge' CONDA_DEPENDENCIES='cython'

    allow_failures:
        - os: linux
          env: PYTHON_VERSION=3.4 PYTEST_VERSION=3.1 PIP_FALLBACK=false

before_install:
    - ln -s . ci-helpers
    - source ci-helpers/travis/setup_conda.sh

script:
   - eval $TEST_CMD

after_success:
   - if [[ $SETUP_CMD == *coverage* ]]; then coveralls; fi
